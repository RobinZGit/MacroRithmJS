<html>
  <head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- Настройка viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Подключаем Bootstrap CSS 
    <link rel="stylesheet" href="css/bootstrap.min.css" > -->
	<title>Calendar</title>

<style>"font-size: 200%" 
</style>
<script>
/*
 1. сетка. массив лет/месяцев/недель/дней/часов... (размерность сетки) от начальной до конечной точки
 -выкидываем из массива часть точек (опр. периоды размерности сетки (пн-пт) и тп.)
 -если нужно выкидываем из остатка точки по ФУНКЦИИ ЧАСТОТЫ. Тогда нужна еще
 СУПЕРРАЗМЕРНОСТЬ. Напр размерность день суперразмерность неделя. Функция частоты от 0 до 1. 
 Считаем ее значение в начале каждого интервала суперразмерности
 кол во точек которые надо оставить в интервале равно этой частоте умножить на кол во точек в интервале
 эти точки раскидываем по интервалу равномерно начиная с заполненной точки и через равные промежутки
 -в результате остается массив действующих точек. По нему считаем выдавать сообщение или нет. 
 По нему же считаем ОБЪЕМ СЕТКИ = ОБЪЕМ ВРЕМЕНИ

 2. Величина нагрузки. Размерность величины. Считанм по ФОРМУЛЕ-ПОСЛЕДОВАТЕЛЬНОСТИ НАГРУЗКИ 
 */
var Gl_aCalendar=[
	//===  значения колонок  ====
	["id","parentid","globalsid","level","name","period_description","period_type","period_formula","button_onclick"],
	//доступ по имени поля а не по индексу такой:  item[ Gl_aDeals[0].indexOf('name') ]
	//!!! нужно делать доступ по имени поля чтобы всегда можно было добавить поля
	["id","дело-родитель","поле для правильной сортировки в дереве(не заполнять,рассчитается в процессе)","уровень в дереве (не заполнять)","наименование дела","описание периодичности","объект с параметрами ритма","'функция выводить либо не выводить в тек. список'==''","функция вызова онлайн ритма, если нужно вывести в виде кнопки"],
	//===========================

	//workout
	[1,0,0,0,"отжимания вниз головой","по понедельникам","{'volume':'100000','units':'раз','type': 'константа','datebeg':'01.01.2019','dateend':'01.01.2022','valuebeg':'10'}","GlDate.getDay()==1"],
	[2,0,0,0,"подтягивания на одной руке", "по вторникам","","GlDate.getDay()==2"],
	[3,0,0,0,"флаг", "по четвергам","","GlDate.getDay()==4"],
	[4,0,0,0,"флаг", "по пятницам","","GlDate.getDay()==5"],
	[5,0,0,0,"спичаги с брусьев на количество", "по субботам","","GlDate.getDay()==6"],
	[6,0,0,0,"спичаги с рук на количество. ходьба на руках.","", "по воскресеньям","GlDate.getDay()==0"],
    [7,0,0,0,"5 и 5 минут дриблинг с бросками. легкий бег либо ролики либо степ","утро раб. дня на удаленке","","(GlDate.getDay() in [1,2,4,5])&&(GlDate.getHours()<11 )"],
    [8,0,0,0,"5 и 5 минут дриблинг с бросками. степ с резиной","вечер раб. дня на удаленке","","(GlDate.getDay() in [1,2,4,5])&&(GlDate.getHours()>11 )"],

	//health and imp
	[101,0,0,0,"'не есть до ' + switch (4){case 4: '17';case 6: '18';default: '19';}", "по средам","","GlDate.getDay()==3","alert('100500')"],
    [102,0,0,0,"дых. в обед равномерно увелич по шагам", "","","true",],

	//imp
	[100001,0,0,0,"6 мин из 60 стоп", "по выходным","","true",""],

	//тест 
	/*
	 [1000002,2,0,0,"222 ТЕСТ + switch (4){case 4: '17';case 6: '18';default: '19';}", "всегда","","true","alert('100500')"],
	 [1000003,8,0,0,"888 ТЕСТ + switch (4){case 4: '17';case 6: '18';default: '19';}", "всегда","","true","alert('100500')"],
	 [1000004,2,0,0,"222 ТЕСТ + switch (4){case 4: '17';case 6: '18';default: '19';}", "всегда","","true","alert('100500')"],
	 [1000005,1000003,0,0,"потомок 222 ТЕСТ + switch (4){case 4: '17';case 6: '18';default: '19';}", "всегда","","true","alert('100500')"],
	 */

];

//основной объект - бд и методы
var glOcalendar =
{table:Gl_aCalendar,
	blockLen:10, //кол во цифр на блок одного ид.  ид дб строго меньше blockLen
	treeLen:1,   //высота дерева, расчитывается в calcSortFields
	check:function() { //проверка целостности бд
        this.table.forEach(
			function(item, i, arr) { 
				if (i > 1)
				{
					//error 1
					if (String(item[arr[0].indexOf('id')]).length >= glOcalendar.blockLen)  //!не видит this.blockLen
						alert("Error 1: Превышение максимальной длины поля id = " + String(item[arr[0].indexOf('id')])
							  + ". Внесите изменения в данные. id должен быть не длиннее " + (glOcalendar.blockLen - 1) + " символов.");     	

					//error 2
					for (j = i + 1;j < arr.length;j++)
						if (item[arr[0].indexOf('id')] ==
							arr[j][arr[0].indexOf('id')])
							alert("Error 2: Найдено более одного элемента с id = " + item[arr[0].indexOf('id')]
								  + ". Внесите изменения в данные. id должен быть уникальным");     

					//error 3
					var currPar = item[arr[0].indexOf('parentid')];
					if (currPar > 0)
						if (arr
							.filter(function(item1, i1, arr1) {
										return currPar == item1[arr[0].indexOf('id')];}
									)
							.length == 0)
							alert("Error 3: Не найдено элемента по ссылке parentid = " + item[arr[0].indexOf('parentid')]
								  + ". Внесите изменения в данные. Данному значению должен соответствовать один элемент (его id должен быть равен указанному parentid)");     

				}		

			});
	},
	calcSortFields:function() {
	    //расчет глобального номера в дереве
		//к Ид элемента приписываем слева ид всех его родителей 
		//(блоками по 20 символов дополненных слева нулями)
		//параллельно считаем высоту дерева, 
		//и при втором проходе дописываем справа блоки по blockLen девяток у неконцевых вершин чтобы все номера были равной длины
		this.treeLen = 1;
		for (var el in this.table)
			if (el > 1) //заголовочную часть массива не меняем!
			{
				this.table[el][this.table[0].indexOf('globalsid')] = String(this.table[el][this.table[0].indexOf('id')]).padStart(this.blockLen, '0');
				var pid = parseInt(this.table[el][this.table[0].indexOf('parentid')]);
				var nLevel0 = 1;
				while (pid > 0)
				{
					this.table[el][this.table[0].indexOf('globalsid')] = String(pid).padStart(this.blockLen, '0') + String(this.table[el][this.table[0].indexOf('globalsid')]).padStart(this.blockLen, '0');
					try
					{
						pid = this.table
							.filter(function(item, i, arr) {
										try
										{return parseInt(item[arr[0].indexOf('id')]) == pid;} catch (e) {return false;};
									})
							[0][this.table[0].indexOf('parentid')];
						nLevel0 += 1;
						if (nLevel0 > this.treeLen) this.treeLen  = nLevel0;
					} catch (e) {pid = -1;}
				}
				this.table[el][this.table[0].indexOf('level')] = nLevel0;
			}
		for (var el in this.table)
			if (el > 1) //заголовочную часть массива не меняем!
				if (this.table[el][this.table[0].indexOf('globalsid')].length < this.treeLen * this.blockLen)
					this.table[el][this.table[0].indexOf('globalsid')] = String(this.table[el][this.table[0].indexOf('globalsid')]).padEnd(this.treeLen * this.blockLen, '9');
//
	}
};

//пытаемся вычислить строку как формулу. если не получается оставляем строку как есть
function ev(s) {
	if (!((s.trim()) == ""))
		try
		{return eval(s);} catch(e) {return s;}
	else return "";
}

function resizeAll() {
	// button.style.width = document.body.clientWidth - 20; 
	// GltxtSpeek.style.width = button.style.width;
}

//основная функция. вывод списка текеущих дел
function loadCurrentData() {


	//проверки целостности б.д.
	glOcalendar.check();

	//нумерация с учетом иерархии
	glOcalendar.calcSortFields();


	var GlDate = new Date();
	var div = document.createElement("div");
	div.innerHTML = "<ul>";
	glOcalendar.table

	    //оставляем только необходимые на дату вывода дела
		.filter(function(item, i, arr) { try
					{ return eval(item[arr[0].indexOf('period_formula')]) > 0;} catch (e) {return false;};})

		//сортрируем по globalsid, чтобы вывести полностью раскрытый список-дерево
		.sort(function(a, b) {if (String(a[Gl_aCalendar[0].indexOf('globalsid')]) > String(b[Gl_aCalendar[0].indexOf('globalsid')])) return -1; else return 1; 
				  ;})
		.forEach(
		function(item, i, arr) { 

			// Добавляем HTML-контент с пом. свойства innerHTML
			div.innerHTML += '<li style="visibility:inherited;font-size:'
				//уменьшение шрифта для подуровней
				+ (300 / (2 + item[glOcalendar.table[0].indexOf('level')])) + '%">' 
				//отступ для подуровней
				+ String(" ").padStart((item[glOcalendar.table[0].indexOf('level')] - 1) * 10, "..........")
			    //+ String(glOcalendar.treeLen) + ' - '
				//+ String(item[glOcalendar.table[0].indexOf('level')]) + ' - '
				//+ String(item[glOcalendar.table[0].indexOf('globalsid')]) + ' - '
				+ ev(item[glOcalendar.table[0].indexOf('name')]) 
				+ ' - ' 
				+ ev(item[glOcalendar.table[0].indexOf('period_description')]);// + '</>';
			if (!!item[glOcalendar.table[0].indexOf('button_onclick')])  
				if (item[glOcalendar.table[0].indexOf('button_onclick')].trim().length > 0)
					div.innerHTML += '<button ' + ' onclick="' + item[glOcalendar.table[0].indexOf('button_onclick')] + '">Запустить</>';
			div.innerHTML += '</li><p> ' + '</p><p> </p>';
		});
    div.innerHTML += "</ul>";
	document.getElementById("divInit").appendChild(div);
}  





//================================================
//калькулятор ритмов
var button  = document.getElementById("idStartBtn");
function startCalculator() {
	//document.getElementById("divCalendar").removeChild();
	if (!document.getElementById("divCalendar").hasChildNodes())
	{
		var sSelectSetkaDimension = '<select><option disabled>Выберите размерность:</option><option value="час">час</option><option selected value="день">день</option><option value="неделя">неделя</option><option value="месяц">месяц</option><option value="год">год</option></select>';

		//
		var div = document.createElement("div");
		div.innerHTML = '<div>'  + 'Калькулятор ритма' + '\n</>';
		document.getElementById("divCalendar").appendChild(div);
		//
		div = document.createElement("div");
		div.innerHTML = '<li>'  + 'Настройка временной сетки' + '\n</>';
		document.getElementById("divCalendar").appendChild(div);
		//
		div = document.createElement("div");
		div.innerHTML = '<label>'  + 'Размерность сетки' + '\n</>';
		document.getElementById("divCalendar").appendChild(div);
		//
		div = document.createElement("div");
		div.innerHTML = sSelectSetkaDimension;
		div = document.getElementById("divCalendar").appendChild(div);
		//
		div = document.createElement("div");
		div.innerHTML = '<div>'  + 'Размерность отрезка разбинения (д.б. крупней размерности сетки, например "неделя" для размерности "день")' + '\n</>';
		document.getElementById("divCalendar").appendChild(div);
		// !сделать пред размерность плюс уровень выше
		div = document.createElement("div");
		div.innerHTML = sSelectSetkaDimension;
		div = document.getElementById("divCalendar").appendChild(div);
		//
		div = document.createElement("div");
		div.innerHTML = '<p>Дата начала периода: <input type="date" name="calendar">';
		div = document.getElementById("divCalendar").appendChild(div);
		//
		div = document.createElement("div");
		div.innerHTML = '<p>Дата окончания периода: <input type="date" name="calendar">';
		div = document.getElementById("divCalendar").appendChild(div);

		//
		//
		div = document.createElement("div");
		div.innerHTML = '<li>'  + 'Настройка ритма на сетке' + '\n</>';
		document.getElementById("divCalendar").appendChild(div);
		//
		// ? не работает скрыть все..
		div = document.createElement("div");
		div.innerHTML = '<button onclick="document.getElementById("divCalendar").deleteData()">'  + 'Скрыть калькулятор' + '\n</>';
		document.getElementById("divCalendar").appendChild(div);
		//
	}
}
</script>


  </head>
  <body onload="loadCurrentData()" onresize = "resizeAll()" style="color: #633366; font-size:250%">
	<h3 class="bg-primary p-a-1">Текущие дела: </h3>
	<div id="divInit" style="display:1;visibility:visible;color:#633366; font-size:90%"></div>
	<!--
	<p>
	<textarea id = "idTextsToSpeek" style = "width:600px;height:400px"></textarea>
	</p>
	-->
	<p></p>
	<p></p>
	<p>
	  <button id = "idCalculator" style = "width:200px;height:30px" onclick="startCalculator()" >Калькулятор ритмов</button>
	</p>
	<div id = "divCalendar" style="color: #333366; font-size:100%"></div>
  </body>
</html>
