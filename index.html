<html>
  <head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- Настройка viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Подключаем Bootstrap CSS 
    <link rel="stylesheet" href="css/bootstrap.min.css" > -->
	<title>Calendar</title>

<style>"font-size: 100%" 
</style>
<script>
/*
 1. сетка. массив лет/месяцев/недель/дней/часов... (размерность сетки) от начальной до конечной точки
 -выкидываем из массива часть точек (опр. периоды размерности сетки (пн-пт) и тп.)
 -если нужно выкидываем из остатка точки по ФУНКЦИИ ЧАСТОТЫ. Тогда нужна еще
 СУПЕРРАЗМЕРНОСТЬ. Напр размерность день суперразмерность неделя. Функция частоты от 0 до 1. 
 Считаем ее значение в начале каждого интервала суперразмерности
 кол во точек которые надо оставить в интервале равно этой частоте умножить на кол во точек в интервале
 эти точки раскидываем по интервалу равномерно начиная с заполненной точки и через равные промежутки
 -в результате остается массив действующих точек. По нему считаем выдавать сообщение или нет. 
 По нему же считаем ОБЪЕМ СЕТКИ = ОБЪЕМ ВРЕМЕНИ

 2. Величина нагрузки. Размерность величины. Считанм по ФОРМУЛЕ-ПОСЛЕДОВАТЕЛЬНОСТИ НАГРУЗКИ 
 */



//============================================================ 
//============================================================ 
//============================================================ 
//============================================================ 
var DATABASE_aCalendar=[
	//===  значения колонок  ====
	["id"
		,"parentid"
		,"globalsid"
		,"level"
		,"formula"
		,"popravka"
		,"dimension"
		,"name"
		,"period_description"
		,"period_formula"
		,"button_onclick"
		,"style"
	],
	//доступ по имени поля а не по индексу такой:  item[ Gl_aDeals[0].indexOf('name') ]
	//!!! нужно делать доступ по имени поля чтобы всегда можно было добавить поля
	["id"
		,"дело-родитель"
		,"поле для правильной сортировки в дереве(не заполнять,рассчитается в процессе)"
		,"уровень в дереве (не заполнять)"
		,"формула нагрузки дела"
		,"поправка к формуле. например формула - линейный ритм, а поправка - синусоидальный множитель или добавок "
		,"размерность нагрузки"
		,"наименование дела"
		,"описание периодичности"
		,"'функция выводить либо не выводить в тек. список'==''"
		,"функция вызова онлайн ритма, если нужно вывести в виде кнопки"
		,"можно задать особый стиль, подставится в атрибут тэга элемента"
	],
	//===========================

	//workout
	[1,0,0,0,"","","","отжимания вниз головой","по понедельникам","glOcalendar.currDate.getDay()==1","",""],
	[2,0,0,0,"","","","подтягивания на одной руке", "по вторникам","glOcalendar.currDate.getDay()==2","",""],
	[3,0,0,0,"","","","флаг", "по четвергам","glOcalendar.currDate.getDay()==4","",""],
	[4,0,0,0,"","","","флаг", "по пятницам","glOcalendar.currDate.getDay()==5","",""],
	[5,0,0,0,"","","","спичаги с брусьев на количество", "по субботам","glOcalendar.currDate.getDay()==6","",""],
	[6,0,0,0,"","","","спичаги с рук на количество. ходьба на руках.", "по воскресеньям","(glOcalendar.currDate.getDay()==0)","","font-size:100%"],
    [7,0,0,0,"","","","5 и 5 минут дриблинг с бросками. легкий бег либо ролики либо степ","утро раб. дня на удаленке","(( [1,2,4,5].indexOf(glOcalendar.currDate.getDay())>=0))&&(glOcalendar.currDate.getHours()<11 )","",""],
    [8,0,0,0,"","","","5 и 5 минут дриблинг с бросками. степ с резиной","вечер раб. дня на удаленке","(( [1,2,4,5].indexOf(glOcalendar.currDate.getDay())>=0))&&(glOcalendar.currDate.getHours()>11 )","",""],

	//health and imp
	[101,0,0,0,"switch (4){case 4: '17';case 6: '18';default: '19';}",""," часов дня","не есть до", "по средам","glOcalendar.currDate.getDay()==3","alert('100500')",""],
    [102,0,0,0,"Math.round(glOcalendar.rithmLinear(glOcalendar.toNum(glOcalendar.currDate,'date'),{x:20200101,y:12},{x:20211212,y:20}))"
		,"+Math.round((glOcalendar.rithmSin(glOcalendar.toNum(glOcalendar.currDate,'date'),20200101,20200128,2,0,4)))"
		,"раз(вдох и столько же выдох)","дых. в обед равномерно увелич по шагам","","true","",""],

	//imp
	[100001,0,0,0,"","","","6 мин из 60 стоп", "по выходным","true","",""],

	//imp
	[100002,0,0,0,"","","","придумать ритм переноса еды с вечера на пораньше", "по частоте","glOcalendar.rithmFrequency(glOcalendar.toNum(glOcalendar.currDate,'date'),{numerator:1,denominator:5})","","font-size:200%"],

	//тест 
	/*
	 [1000200,2,0,0,"","","222 ТЕСТ + switch (4){case 4: '17';case 6: '18';default: '19';}", "всегда","","true","alert('100500')"],
	 [1000300,8,0,0,"","","888 ТЕСТ + switch (4){case 4: '17';case 6: '18';default: '19';}", "всегда","","true","alert('100500')"],
	 [1000400,2,0,0,"","","222 ТЕСТ + switch (4){case 4: '17';case 6: '18';default: '19';}", "всегда","","true","alert('100500')"],
	 [1000500,1000200,0,0,"","","потомок 222 ТЕСТ + switch (4){case 4: '17';case 6: '18';default: '19';}", "всегда","","true","alert('100500')"],
	 */

];
//============================================================ 
//============================================================ 
//============================================================ 
//============================================================ 



//основной объект - бд и методы
var glOcalendar =
{
    table: DATABASE_aCalendar, //БАЗА ДАННЫХ
	currDate: new Date(),

	//== служебные свойства ==
	blockLen:10, //кол во цифр на блок одного ид.  ид дб строго меньше blockLen
	treeLen:1,   //высота дерева, расчитывается в calcSortFields
    zagolovokRows:2, //количество строк в бд для описания наименований, типов и пр
    //========================


	//переводит дату в число до лет/месяцев/недель/дней/часов/минут/секунд
	//yyyymmddhhmiss
	toNum: function(date, sMode) {
		switch (sMode)
		{
			case "year": return date.getFullYear();
			case "month": return date.getFullYear() * 100 + date.getMonth();
				//! это не неделя по порядку ! case "day": return date.getFullYear()*1000 + date.getMonth()*10 + date.getDay();
			case "date": return date.getFullYear() * 10000 + date.getMonth() * 100 + date.getDate();
			case "hours": return date.getFullYear() * 1000000 + date.getMonth() * 10000 + date.getDate() * 100 + date.getHours();
			case "minutes": return date.getFullYear() * 100000000 + date.getMonth() * 1000000 + date.getDate() * 10000 + date.getHours() * 100 + date.getMinutes();
			case "seconds": return date.getFullYear() * 10000000000 + date.getMonth() * 100000000 + date.getDate() * 1000000 + date.getHours() * 10000 + date.getMinutes() * 100 + date.getSeconds();

		}
	},


	//линейный ритм с начальным и конечным значениями {rBeg.x,rBeg.y} {rEnd.x,rEnd.y}
	//возвращает значение в точке х. 
	rithmLinear: function(x, oBeg, oEnd) {
		return oBeg.y + (x - oBeg.x) * (oEnd.y - oBeg.y) / (oEnd.x - oBeg.x);
	},


	//синусоидальный ритм с nCycles периодов на отрезке xBeg,xEnd, средним значением nAverage и амплитудой nAmplitude
	//возвращает значение в точке х. 
	rithmSin: function(x, xBeg, xEnd, nCycles, nAverage, nAmplitude) {
		return nAverage + nAmplitude * Math.sin((x - xBeg) * 2 * 3.1415 * nCycles / (xEnd - xBeg));
	},


	//ритм по частоте появления: oFreq.numerator/oFreq.denominator
	//    выстраивает блоки по oFreq.denominator точек и отмечает их 0 или 1
	//    начинает с 1, потом идут oFreq.numerator/oFreq.denominator-1  нулей
	//    точность дроби видит до тысячных
	//возвращает значение 0 или 1 в точке n. 
	rithmFrequency: function(n, oFreq) {
		return (((n * 1000) % (Math.floor(1000 * oFreq.numerator / oFreq.denominator))) != 0);
	},


	//возвращает true с вероятностью probability, иначе false (испытание Бернулли)
	//  пример вызова glOcalendar.bernulli(0.5)
	bernulli: function(probability) {
		return (probability >= Math.random());
	},

	check: function() { //проверка целостности бд
        this.table.forEach(
			function(item, i, arr) { 
				if (i > 1)
				{
					//error 1
					if (String(item[arr[0].indexOf('id')]).length >= glOcalendar.blockLen)  //!не видит this.blockLen
						alert("Error 1: Превышение максимальной длины поля id = " + String(item[arr[0].indexOf('id')])
							  + ". Внесите изменения в данные. id должен быть не длиннее " + (glOcalendar.blockLen - 1) + " символов.");     	

					//error 2
					for (j = i + 1;j < arr.length;j++)
						if (item[arr[0].indexOf('id')] ==
							arr[j][arr[0].indexOf('id')])
							alert("Error 2: Найдено более одного элемента с id = " + item[arr[0].indexOf('id')]
								  + ". Внесите изменения в данные. id должен быть уникальным");     

					//error 3
					var currPar = item[arr[0].indexOf('parentid')];
					if (currPar > 0)
						if (arr
							.filter(function(item1, i1, arr1) {
										return currPar == item1[arr[0].indexOf('id')];}
									)
							.length == 0)
							alert("Error 3: Не найдено элемента по ссылке parentid = " + item[arr[0].indexOf('parentid')]
								  + ". Внесите изменения в данные. Данному значению должен соответствовать один элемент (его id должен быть равен указанному parentid)");     

				}		

			});
	},


	calcSortFields:function() {
	    //расчет глобального номера в дереве
		//к Ид элемента приписываем слева ид всех его родителей 
		//(блоками по 20 символов дополненных слева нулями)
		//параллельно считаем высоту дерева, 
		//и при втором проходе дописываем справа блоки по blockLen девяток у неконцевых вершин чтобы все номера были равной длины
		this.treeLen = 1;
		for (var el in this.table)
			if (el > this.zagolovokRows - 1) //заголовочную часть массива не меняем!
			{
				this.table[el][this.table[0].indexOf('globalsid')] = String(this.table[el][this.table[0].indexOf('id')]).padStart(this.blockLen, '0');
				var pid = parseInt(this.table[el][this.table[0].indexOf('parentid')]);
				var nLevel0 = 1;
				while (pid > 0)
				{
					this.table[el][this.table[0].indexOf('globalsid')] = String(pid).padStart(this.blockLen, '0') + String(this.table[el][this.table[0].indexOf('globalsid')]).padStart(this.blockLen, '0');
					try
					{
						pid = this.table
							.filter(function(item, i, arr) {
										try
										{return parseInt(item[arr[0].indexOf('id')]) == pid;} catch (e) {return false;};
									})
							[0][this.table[0].indexOf('parentid')];
						nLevel0 += 1;
						if (nLevel0 > this.treeLen) this.treeLen  = nLevel0;
					} catch (e) {pid = -1;}
				}
				this.table[el][this.table[0].indexOf('level')] = nLevel0;
			}
		for (var el in this.table)
			if (el > this.zagolovokRows - 1) //заголовочную часть массива не меняем!
				if (this.table[el][this.table[0].indexOf('globalsid')].length < this.treeLen * this.blockLen)
					this.table[el][this.table[0].indexOf('globalsid')] = String(this.table[el][this.table[0].indexOf('globalsid')]).padEnd(this.treeLen * this.blockLen, '9');
//
	},


	//полностью раскрытый список дел
	//  nMode = 0 - все дела
	//  nMode = 1 - теkszsssущие на this.currDate дела
	innerHTMLexpandedTree: function(nMode) { 

		var sHTML = "<ul>";
		this.table
			//оставляем только необходимые на дату вывода дела
			.filter(function(item, i, arr) { 
						switch (nMode)
						{
							case 0:
								return (i > (glOcalendar.zagolovokRows - 1));
							case 1:
								try
								{ 
									return eval(item[arr[0].indexOf('period_formula')]) > 0;
								} catch (e) {return false;}
						}
					}
					)
			//сортрируем по globalsid, чтобы вывести полностью раскрытый список-дерево
			.sort(function(a, b) {if (String(a[glOcalendar.table[0].indexOf('globalsid')]) > String(b[glOcalendar.table[0].indexOf('globalsid')])) return -1; else return 1; 
					  ;})
			.forEach(
			function(item, i, arr) { 
				// Добавляем HTML-контент с пом. свойства innerHTML
				sHTML += '<li style="' + item[glOcalendar.table[0].indexOf('style')] + '">'//visibility:inherited;font-size:'
					//уменьшение шрифта для подуровней
					//+ (300 / (2 + item[glOcalendar.table[0].indexOf('level')])) + '%">' 
					//+ '100%">'
					//отступ для подуровней
					+ String(" ").padStart((item[glOcalendar.table[0].indexOf('level')] - 1) * 10, "..........")
					+ (item[glOcalendar.table[0].indexOf('name')]) 
					+ ((String(item[glOcalendar.table[0].indexOf('formula')]).length == 0) ?"": (".   Средняя нагрузка: " + ev(item[glOcalendar.table[0].indexOf('formula')])  + " " + (item[glOcalendar.table[0].indexOf('dimension')])))
					+ ((String(item[glOcalendar.table[0].indexOf('popravka')]).length == 0) ?"": (".   Рекомендуемая нагрузка с учетом поправки: <span style='color: red; font-weight: bold'>" + ev(item[glOcalendar.table[0].indexOf('formula')] + item[glOcalendar.table[0].indexOf('popravka')]) + " " + (item[glOcalendar.table[0].indexOf('dimension')]) +"</span>"))
					+ '   ' 
					+ ev(item[glOcalendar.table[0].indexOf('period_description')]);// + '</>';
				if (!!item[glOcalendar.table[0].indexOf('button_onclick')])  
					if (item[glOcalendar.table[0].indexOf('button_onclick')].trim().length > 0)
						sHTML += '<button ' + ' onclick="' + item[glOcalendar.table[0].indexOf('button_onclick')] + '">Запустить</>';
				sHTML += '</li><p> ' + '</p><p> </p>';
			});
		sHTML += "</ul>";
		return sHTML;
	},


    //список текущих дел
	innerHTMLexpandedTreeCurrent: function() {
		return this.innerHTMLexpandedTree(1);
	},
	
	//выводим список текущих дел
	showExpandedTreeCurrent: function() {
      var label= document.createElement("label");
	  label.innerHTML =  "<p><label>--------- "+glOcalendar.currDate+" --------------</label><p>";
	  document.getElementById("txt_1").appendChild(label);

	  var div = document.createElement("div");
	  div.innerHTML =  glOcalendar.innerHTMLexpandedTreeCurrent();
	  document.getElementById("txt_1").appendChild(div);
	  
	  var label2= document.createElement("label");
	  label2.innerHTML =  "<p><label>---------------------------------------</label><p>";
	  document.getElementById("txt_1").appendChild(div);
	}, 

	//список всех дел
	innerHTMLexpandedTreeAll: function() {
		return this.innerHTMLexpandedTree(0);
	},
	
	//выводим список всех дел
	showExpandedTreeAll: function() {
	  var div = document.createElement("div");
	  div.innerHTML =  glOcalendar.innerHTMLexpandedTreeAll();
	  document.getElementById("txt_2").appendChild(div);
	}  


};

//пытаемся вычислить строку как формулу. если не получается оставляем строку как есть
function ev(s) {
	if (!((s.trim()) == ""))
		try
		{return eval(s);} catch(e) {return s;}
	else return "";
}

function resizeAll() {
	// button.style.width = document.body.clientWidth - 20; 
	// GltxtSpeek.style.width = button.style.width;
}

//основная функция. вывод списка текущих дел
function loadCurrentData() {

	//проверки целостности б.д.
	glOcalendar.check();

	//нумерация с учетом иерархии
	glOcalendar.calcSortFields();

	//выводим список текущих дел
	glOcalendar.showExpandedTreeCurrent();

	
	var buttonNext  = document.createElement("div");
	buttonNext.innerHTML =  "<p><button onclick = '{glOcalendar.currDate.setDate(glOcalendar.currDate.getDate()+1);;glOcalendar.showExpandedTreeCurrent();}'>Next day</button></p>";
	document.getElementById("txt_1").appendChild(buttonNext);
    
	buttonEdit  = document.createElement("div");
	buttonEdit.innerHTML =  "<p><a href = 'https://github.com/RobinZGit/MacroRithmJS/blob/master/index.html'>Edit</button></p>";
	document.getElementById("txt_1").appendChild(buttonEdit);
 
	//выводим список всех дел
	glOcalendar.showExpandedTreeAll();
//https://github.com/RobinZGit/MacroRithmJS/blob/master/index.html

}  





//================================================
//калькулятор ритмов
/*
 var button  = document.getElementById("idStartBtn");
 function startCalculator() {
 //document.getElementById("divCalendar").removeChild();
 if (!document.getElementById("divCalendar").hasChildNodes())
 {
 var sSelectSetkaDimension = '<select><option disabled>Выберите размерность:</option><option value="час">час</option><option selected value="день">день</option><option value="неделя">неделя</option><option value="месяц">месяц</option><option value="год">год</option></select>';

 //
 var div = document.createElement("div");
 div.innerHTML = '<div>'  + 'Калькулятор ритма' + '\n</>';
 document.getElementById("divCalendar").appendChild(div);
 //
 div = document.createElement("div");
 div.innerHTML = '<li>'  + 'Настройка временной сетки' + '\n</>';
 document.getElementById("divCalendar").appendChild(div);
 //
 div = document.createElement("div");
 div.innerHTML = '<label>'  + 'Размерность сетки' + '\n</>';
 document.getElementById("divCalendar").appendChild(div);
 //
 div = document.createElement("div");
 div.innerHTML = sSelectSetkaDimension;
 div = document.getElementById("divCalendar").appendChild(div);
 //
 div = document.createElement("div");
 div.innerHTML = '<div>'  + 'Размерность отрезка разбинения (д.б. крупней размерности сетки, например "неделя" для размерности "день")' + '\n</>';
 document.getElementById("divCalendar").appendChild(div);
 // !сделать пред размерность плюс уровень выше
 div = document.createElement("div");
 div.innerHTML = sSelectSetkaDimension;
 div = document.getElementById("divCalendar").appendChild(div);
 //
 div = document.createElement("div");
 div.innerHTML = '<p>Дата начала периода: <input type="date" name="calendar">';
 div = document.getElementById("divCalendar").appendChild(div);
 //
 div = document.createElement("div");
 div.innerHTML = '<p>Дата окончания периода: <input type="date" name="calendar">';
 div = document.getElementById("divCalendar").appendChild(div);

 //
 //
 div = document.createElement("div");
 div.innerHTML = '<li>'  + 'Настройка ритма на сетке' + '\n</>';
 document.getElementById("divCalendar").appendChild(div);
 //
 // ? не работает скрыть все..
 div = document.createElement("div");
 div.innerHTML = '<button onclick="document.getElementById("divCalendar").deleteData()">'  + 'Скрыть калькулятор' + '\n</>';
 document.getElementById("divCalendar").appendChild(div);
 //
 }

 }
 */
</script>


  </head>
  <body onload="loadCurrentData()" onresize = "resizeAll()" style="color: #633366; font-size:100%">
	<h3 class="bg-primary p-a-1">Календарь: </h3>

<style type="text/css">
.tabs { width: 100%; padding: 0px; margin: 0 auto; }
.tabs>input { display: none; }
.tabs>div {
    display: none;
    padding: 12px;
    border: 1px solid #C0C0C0;
    background: #FFFFFF;
}
.tabs>label {
    display: inline-block;
    padding: 7px;
    margin: 0 -5px -1px 0;
    text-align: center;
    color: #666666;
    border: 1px solid #C0C0C0;
    background: #E0E0E0;
    cursor: pointer;
}
.tabs>input:checked + label {
    color: #000000;
    border: 1px solid #C0C0C0;
    border-bottom: 1px solid #FFFFFF;
    background: #FFFFFF;
}
#tab_1:checked ~ #txt_1,
#tab_2:checked ~ #txt_2,
#tab_3:checked ~ #txt_3,
#tab_4:checked ~ #txt_4 { display: block; }
</style>

	<div class="tabs">
	  <input type="radio" name="inset" value="" id="tab_1" checked>
	  <label for="tab_1">Текущие дела</label>

	  <input type="radio" name="inset" value="" id="tab_2">
	  <label for="tab_2">Все дела</label>
	  <!--
	  <input type="radio" name="inset" value="" id="tab_3">
	  <label for="tab_3">Вкладка №3</label>

	  <input type="radio" name="inset" value="" id="tab_4">
	  <label for="tab_4">Вкладка №4</label>
	  -->
	  <div id="txt_1">
		<!--
        <p>Произвольное содержимое...</p>
        <p>Произвольное содержимое...</p>
        <p>Произвольное содержимое...</p>
		-->
	  </div>
	  <div id="txt_2">
		<!--        <p>Вторая вкладка</p>   -->
	  </div>
	  <!--
	  <div id="txt_3">
	  <p>Размеры содержимого вкладок</p>
	  <p>могут отличаться по высоте!</p>
	  </div>
	  <div id="txt_4">
	  <img src="image/logo.png" width="533" height="77" alt="Лого">
	  </div>
	  -->
	</div>


  </body>
</html>
